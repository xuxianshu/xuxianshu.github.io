<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚ ì§œì™€ ì‹œê°„ ë§í•˜ê¸° ì—°ìŠµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Jua', sans-serif;
            touch-action: manipulation;
        }
        .game-container {
            background: linear-gradient(135deg, #fdfcdc, #f0fff0);
            border: 4px solid #bbf7d0; /* green-200 */
        }
        .calendar {
            background-color: #fef9c3; /* yellow-100 */
            border: 3px solid #fde047; /* yellow-300 */
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            min-width: 220px;
        }
        #digital-clock-container {
            min-width: 220px;
        }
        #record-btn.recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(251, 146, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0); }
        }
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .feedback-show {
            animation: pop-in 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        .audio-btn {
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-green-50 flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto max-w-2xl">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 game-container">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-green-600">ğŸ¼ íŒë‹¤ì˜ ì‹œê°„ íƒí—˜ëŒ€ ğŸ•°ï¸</h1>
                <p class="text-gray-500 mt-2 text-lg">ë‹¬ë ¥ê³¼ ì‹œê³„ë¥¼ ë³´ê³  ì§ˆë¬¸ì— ë‹µí•´ë´ìš”!</p>
            </header>
            
            <section id="profile-info" class="hidden text-center mb-4 text-lg text-gray-700 bg-white/60 p-2 rounded-lg">
                <p>ğŸ‚ <span class="font-bold">ê·¸ì˜ ìƒì¼:</span> <span id="birthday-info"></span></p>
            </section>

            <!-- ë‹¬ë ¥ ë° ì‹œê³„ ì„¹ì…˜ -->
            <section class="flex flex-row flex-wrap items-center justify-center gap-6 mb-6">
                <div id="calendar-container" class="calendar flex-1">
                    <div id="month" class="text-2xl font-bold text-yellow-700 bg-yellow-200 rounded-t-lg py-1">1ì›”</div>
                    <div class="text-base font-bold text-red-600 bg-red-200 rounded-full px-4 py-1 my-2 inline-block">ì˜¤ëŠ˜</div>
                    <div id="day" class="text-7xl font-bold text-yellow-900 py-2">1</div>
                    <div id="weekday" class="text-xl text-yellow-800 bg-yellow-200 rounded-b-lg py-1">ì›”ìš”ì¼</div>
                </div>
                <div id="digital-clock-container" class="flex-1 flex flex-col items-center justify-center h-40 bg-white rounded-2xl shadow-lg border-4 border-emerald-300">
                    <span id="digital-time-period" class="text-3xl font-bold text-emerald-500">ì˜¤ì „</span>
                    <span id="digital-time" class="text-5xl font-mono text-emerald-600 tracking-wider">00:00</span>
                </div>
            </section>
            
            <!-- ì‹œì‘ í™”ë©´ -->
            <section id="start-screen" class="text-center py-4">
                <p class="text-xl mb-4 text-gray-700">ì´ 5ë‹¨ê³„ë¡œ êµ¬ì„±ëœ í€´ì¦ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!</p>
                <button id="start-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-2xl transition-transform transform hover:scale-105 shadow-lg">ì‹œì‘!</button>
                 <p id="start-error" class="text-sm text-red-500 mt-2 h-5"></p>
            </section>

            <!-- í€´ì¦ˆ ì„¹ì…˜ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
            <section id="quiz-section" class="hidden">
                <div id="progress-tracker" class="text-center mb-4 bg-white/50 rounded-lg p-2">
                    <span id="stage-info" class="font-bold text-green-700"></span> | <span id="question-progress" class="text-gray-600"></span>
                </div>
                <div id="mission-card" class="bg-sky-100 border-2 border-sky-300 text-sky-800 p-4 rounded-lg mb-6 text-center shadow-md">
                    <p class="font-bold text-xl">â­ ì˜¤ëŠ˜ì˜ ì§ˆë¬¸! â­</p>
                    <div class="mt-2">
                        <p id="mission-text-hanzi" class="text-2xl text-sky-900 font-bold">ì§ˆë¬¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”...</p>
                        <p id="mission-text-pinyin" class="text-md text-sky-700 mt-1">...</p>
                        <p id="mission-hint" class="text-sm text-sky-600 mt-2 hidden"></p>
                    </div>
                </div>

                <div class="user-response-area mt-4 bg-white p-4 rounded-lg shadow-inner">
                     <p class="font-bold text-left text-gray-600">ğŸ˜„ ê·¸ (tÄ):</p>
                     <input type="text" id="user-input" class="bg-transparent text-gray-800 text-lg placeholder-gray-500 w-full text-center outline-none py-2" placeholder="ìŒì„±ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”" readonly>
                </div>

                <div id="controls" class="text-center mt-6">
                    <button id="record-btn" class="bg-orange-400 hover:bg-orange-500 text-white font-bold p-4 rounded-full transition-transform transform hover:scale-110 shadow-lg inline-flex items-center justify-center" title="ìŒì„±ìœ¼ë¡œ ë‹µë³€í•˜ê¸°">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-12 0H3a7.001 7.001 0 006 6.93V17H7v1h6v-1h-2v-2.07z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>

                <p id="feedback" class="mt-4 text-xl font-semibold h-8 text-center"></p>

                <div class="text-center mt-4">
                    <button id="next-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-5 rounded-full text-lg hidden">ë‹¤ìŒ ë¬¸ì œ</button>
                </div>
            </section>
        </div>
    </div>

    <!-- ë‹¨ê³„ë³„ ê²°ê³¼ íŒì—… -->
    <div id="stage-result-popup" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-2xl w-full max-h-[90vh] flex flex-col">
            <header class="text-center mb-4 flex-shrink-0">
                <h2 id="stage-result-title" class="text-3xl font-bold text-blue-600"></h2>
            </header>
            <div id="stage-result-log" class="flex-grow overflow-y-auto space-y-4 pr-2 border-t pt-4"></div>
            <footer class="mt-6 text-center flex-shrink-0">
                <button id="next-stage-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-xl">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
            </footer>
        </div>
    </div>

    <!-- ìµœì¢… ê²°ê³¼ íŒì—… -->
    <div id="final-result-popup" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div id="final-result-content">
                <header class="text-center mb-4 flex-shrink-0">
                    <h2 class="text-3xl font-bold text-green-600">ğŸ‰ ìµœì¢… ì—°ìŠµ ê²°ê³¼ ğŸ‰</h2>
                </header>
                <div id="final-result-log" class="flex-grow overflow-y-auto space-y-4 pr-2 border-t pt-4 max-h-[50vh]"></div>
            </div>
            <footer class="mt-6 text-center flex-shrink-0 space-y-2 sm:space-x-4">
                <button id="save-result-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-full text-lg">ê²°ê³¼ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
                <button id="restart-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full text-xl mt-2 sm:mt-0">ë‹¤ì‹œí•˜ê¸°</button>
                <button id="close-popup-btn" class="text-gray-500 hover:text-gray-700 text-sm mt-2 sm:mt-0">ë‹«ê¸°</button>
            </footer>
        </div>
    </div>

<script>
// DOM Elements
const stageInfoEl = document.getElementById('stage-info');
const questionProgressEl = document.getElementById('question-progress');
const stageResultPopupEl = document.getElementById('stage-result-popup');
const stageResultTitleEl = document.getElementById('stage-result-title');
const stageResultLogEl = document.getElementById('stage-result-log');
const nextStageBtn = document.getElementById('next-stage-btn');
const finalResultPopupEl = document.getElementById('final-result-popup');
const finalResultLogEl = document.getElementById('final-result-log');
const restartBtn = document.getElementById('restart-btn');
const closePopupBtn = document.getElementById('close-popup-btn');
const saveResultBtn = document.getElementById('save-result-btn');
const profileInfoEl = document.getElementById('profile-info');
const birthdayInfoEl = document.getElementById('birthday-info');
const finalResultContentEl = document.getElementById('final-result-content');
const calendarMonthEl = document.getElementById('month');
const calendarDayEl = document.getElementById('day');
const calendarWeekdayEl = document.getElementById('weekday');
const digitalTimeEl = document.getElementById('digital-time');
const digitalTimePeriodEl = document.getElementById('digital-time-period');
const startScreenEl = document.getElementById('start-screen');
const startBtn = document.getElementById('start-btn');
const startErrorEl = document.getElementById('start-error');
const quizSectionEl = document.getElementById('quiz-section');
const missionTextHanziEl = document.getElementById('mission-text-hanzi');
const missionTextPinyinEl = document.getElementById('mission-text-pinyin');
const missionHintEl = document.getElementById('mission-hint');
const userInputEl = document.getElementById('user-input');
const recordBtn = document.getElementById('record-btn');
const feedbackEl = document.getElementById('feedback');
const nextBtn = document.getElementById('next-btn');

// --- Speech API Setup ---
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

let recognition;
let isRecognizing = false;
let userInteracted = false; // For autoplay policy

if (SpeechRecognition) {
  const SR = SpeechRecognition;
  recognition = new SR();
  recognition.lang = 'zh-CN';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1; // Stability improvement
} else {
  startErrorEl.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
  recordBtn.disabled = true;
  recordBtn.style.display = 'none';
}

// --- Game Data ---
const weekdays = ["æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­"];
const weekdaysKorean = ["ì¼ìš”ì¼", "ì›”ìš”ì¼", "í™”ìš”ì¼", "ìˆ˜ìš”ì¼", "ëª©ìš”ì¼", "ê¸ˆìš”ì¼", "í† ìš”ì¼"];
const timePeriodKorean = { "ä¸Šåˆ": "ì˜¤ì „", "ä¸‹åˆ": "ì˜¤í›„", "æ™šä¸Š": "ì €ë…" };
const morningActivities = ['èµ·åºŠ', 'åƒæ—©é¥­', 'ä¸Šå­¦', 'ä¸Šè¯¾', 'å‡ºå‘'];
const afternoonActivities = ['åƒåˆé¥­', 'åƒéº»è¾£çƒ«', 'å–æ°´', 'å–å¯ä¹', 'ä¸‹è¯¾', 'æ”¾å­¦', 'å»ä¸­å›½', 'å»åŒ—äº¬', 'å»é•¿åŸ', 'åˆ°åŒ—äº¬', 'åˆ°å¤©å®‰é—¨'];
const eveningActivities = ['åƒæ™šé¥­', 'åƒåŒ—äº¬çƒ¤é¸­', 'å›å®¶', 'ç¡è§‰', 'çœ‹äº¬å‰§', 'å–æ°´', 'å–å¯ä¹'];
const chineseNumbers = { '0': 'é›¶', '1': 'ä¸€', '2': 'äºŒ', '3': 'ä¸‰', '4': 'å››', '5': 'äº”', '6': 'å…­', '7': 'ä¸ƒ', '8': 'å…«', '9': 'ä¹', '10': 'å', '11': 'åä¸€', '12': 'åäºŒ', '13': 'åä¸‰', '14': 'ì‹­å››', '15': 'ì‹­ì˜¤', '16': 'ì‹­ìœ¡', '17': 'ì‹­ì¹ ', '18': 'ì‹­íŒ”', '19': 'ì‹­êµ¬', '20': 'ì´ì‹­', '21': 'ì´ì‹­ì¼', '22': 'ì´ì‹­ì´', '23': 'ì´ì‹­ì‚¼', '24': 'ì´ì‹­ì‚¬', '25': 'ì´ì‹­ì˜¤', '26': 'ì´ì‹­ìœ¡', '27': 'ì´ì‹­ì¹ ', '28': 'ì´ì‹­íŒ”', '29': 'ì´ì‹­êµ¬', '30': 'ì‚¼ì‹­', '31': 'ì‚¼ì‹­ì¼' };
const pinyinMap = { '1':'yÄ«','2':'Ã¨r','3':'sÄn','4':'sÃ¬','5':'wÇ”','6':'liÃ¹','7':'qÄ«','8':'bÄ','9':'jiÇ”','10':'shÃ­','11':'shÃ­yÄ«','12':'shÃ­Ã¨r','ì›”':'yuÃ¨','í˜¸':'hÃ o','ì¼':'rÃ¬','ì²œ':'tiÄn','ì„±ê¸°':'xÄ«ngqÄ«','ì„±ê¸°ì²œ':'xÄ«ngqÄ«tiÄn','ìƒ':'shÃ ng','ì˜¤':'wÇ”','í•˜':'xiÃ ','ë§Œ':'wÇn','í˜„':'xiÃ n','ì¬':'zÃ i','ê¸°':'jÇ','ì ':'diÇn','ë¶„':'fÄ“n','ë„ˆ':'nÇ','ë‚˜':'wÇ’','í•˜ë‹¤':'zuÃ²','ë­':'shÃ©n','ë˜ëŠ”':'me','ì˜¤ëŠ˜':'jÄ«n','ì–´ì œ':'zuÃ³','ë‚´ì¼':'mÃ­ng','ìƒ':'shÄ“ng','ì˜':'de','ì´ë‹¤':'shÃ¬', 'ì–‘':'liÇng','ë°˜': 'bÃ n', 'í•œ ê°': 'yÃ­ kÃ¨', 'ì‚¼ê°': 'sÄn kÃ¨','ìƒì˜¤':'shÃ ngwÇ”', 'í•˜ì˜¤':'xiÃ wÇ”', 'ë§Œìƒ':'wÇnshang','ê¸°ìƒ':'qÇchuÃ¡ng','ì¡°ì‹':'chÄ« zÇofÃ n','ì„ì‹':'chÄ« wÇnfÃ n','ì¤‘ì‹':'chÄ« wÇ”fÃ n','ë§¤ë¼íƒ• ë¨¹ë‹¤':'chÄ« mÃ¡lÃ tÃ ng','ë¶ê²½ì˜¤ë¦¬êµ¬ì´ ë¨¹ë‹¤':'chÄ« BÄ›ijÄ«ng kÇoyÄ','ë¬¼ë§ˆì‹œë‹¤':'hÄ“ shuÇ','ì½œë¼ë§ˆì‹œë‹¤':'hÄ“ kÄ›lÃ¨','ë“±êµ':'shÃ ngxuÃ©','í•˜êµ':'fÃ ngxuÃ©','ìˆ˜ì—…':'shÃ ngkÃ¨','ìˆ˜ì—…ë':'xiÃ kÃ¨','ì§‘íšŒ':'huÃ­jiÄ','ì ':'shuÃ¬jiÃ o','ì¶œë°œ':'chÅ«fÄ','ì¤‘êµ­ê°€ë‹¤':'qÃ¹ ZhÅngguÃ³','ë¶ê²½ê°€ë‹¤':'qÃ¹ BÄ›ijÄ«ng','ë§Œë¦¬ì¥ì„±ê°€ë‹¤':'qÃ¹ ChÃ¡ngchÃ©ng','ë¶ê²½ë„ì°©':'dÃ o BÄ›ijÄ«ng','ì²œì•ˆë¬¸ë„ì°©':'dÃ o TiÄnÄnmÃ©n','ê²½ê·¹ë³´ë‹¤':'kÃ n jÄ«ngjÃ¹', 'ê·¸':'tÄ' };

// --- Game State ---
let currentQuestion = {};
let practiceLog = [];
let currentStage = 1;
let questionNumberInStage = 1;
let hisBirthday = {};
const QUESTIONS_PER_STAGE = 4;
const MAX_STAGES = 5;

// --- Helper Functions ---
window.addEventListener('pointerdown', () => { userInteracted = true; }, { once: true });

function speak(text, lang = 'zh-CN', callback) {
    if (!text || !userInteracted) {
        if (callback) callback();
        return;
    }

    if (window.currentAudio && !window.currentAudio.paused) {
        window.currentAudio.pause();
    }
    const encodedText = encodeURIComponent(text);
    const audio = new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=${lang}&client=tw-ob`);
    window.currentAudio = audio;

    const onAudioEnd = () => {
        if (callback) callback();
        audio.removeEventListener('ended', onAudioEnd);
        audio.removeEventListener('error', onAudioEnd);
    };

    audio.addEventListener('ended', onAudioEnd);
    audio.addEventListener('error', onAudioEnd);

    audio.play().catch(() => {
        console.error("TTS Audio play() was rejected.");
        onAudioEnd(); // Ensure callback is called even on play failure
    });
}
function convertFullPhraseToPinyin(text) { if (!text) return ''; const words = Object.keys(pinyinMap).sort((a, b) => b.length - a.length); let remainingText = text; let pinyinText = ''; while (remainingText.length > 0) { let found = false; for (const word of words) { if (remainingText.startsWith(word)) { pinyinText += pinyinMap[word] + ' '; remainingText = remainingText.substring(word.length); found = true; break; } } if (!found) { let char = remainingText[0]; let numKey = Object.keys(chineseNumbers).find(key => chineseNumbers[key] === char); if(numKey && pinyinMap[numKey]){ pinyinText += pinyinMap[numKey] + ' '; } else { pinyinText += char; } remainingText = remainingText.substring(1); } } return pinyinText.trim().replace(/\s+/g, ' '); }
function getChineseMinute(minute) { if (minute === 0) return ''; if (minute < 10) return chineseNumbers[minute.toString()]; if (minute === 10) return 'ì‹­'; if (minute < 20) return 'ì‹­' + chineseNumbers[(minute % 10).toString()]; const tens = Math.floor(minute / 10); const ones = minute % 10; return chineseNumbers[tens.toString()] + 'ì‹­' + (ones > 0 ? chineseNumbers[ones.toString()] : ''); }
function updateCalendar(month, day, dayOfWeek) { calendarMonthEl.textContent = `${month}ì›”`; calendarDayEl.textContent = day; calendarWeekdayEl.textContent = weekdaysKorean[dayOfWeek]; }
function updateDigitalClock(hour, minute, timePeriod) { const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour); const formattedHour = displayHour.toString().padStart(2, '0'); const formattedMinute = minute.toString().padStart(2, '0'); digitalTimeEl.textContent = `${formattedHour}:${formattedMinute}`; digitalTimePeriodEl.textContent = timePeriodKorean[timePeriod]; }
function updateProgressTracker() { const stageNames = ["", "ë‚ ì§œ ë¬»ê¸°", "ìš”ì¼ ë¬»ê¸°", "ì‹œê°„ ë¬»ê¸°", "ì¼ê³¼ ë¬»ê¸°", "ëœë¤ ë¬»ê¸°"]; stageInfoEl.textContent = `ë‹¨ê³„ ${currentStage}: ${stageNames[currentStage]}`; questionProgressEl.textContent = `${questionNumberInStage}/${QUESTIONS_PER_STAGE}`; }
function getDateInfo(baseDate, offset) { const newDate = new Date(2024, baseDate.month - 1, baseDate.day); newDate.setDate(newDate.getDate() + offset); return { month: newDate.getMonth() + 1, day: newDate.getDate(), dayOfWeek: newDate.getDay() }; }

// --- Core Game Logic ---
function generateNewQuestion() {
    const month = Math.floor(Math.random() * 12) + 1;
    const day = Math.floor(Math.random() * 28) + 1;
    const dayOfWeek = new Date(2024, month - 1, day).getDay();
    const minute = Math.floor(Math.random() * 60);
    const timePeriodRoll = Math.random();
    let hour, timePeriod, activity;

    if (timePeriodRoll < 0.33) { timePeriod = "ä¸Šåˆ"; hour = Math.floor(Math.random() * 6) + 6; activity = morningActivities[Math.floor(Math.random() * morningActivities.length)]; } 
    else if (timePeriodRoll < 0.66) { timePeriod = "ä¸‹åˆ"; hour = Math.floor(Math.random() * 6) + 12; activity = afternoonActivities[Math.floor(Math.random() * afternoonActivities.length)]; } 
    else { timePeriod = "æ™šä¸Š"; hour = Math.floor(Math.random() * 6) + 18; activity = eveningActivities[Math.floor(Math.random() * eveningActivities.length)]; }
    
    let questionType;
    if (currentStage === 1) questionType = 1; else if (currentStage === 2) questionType = 2; else if (currentStage === 3) questionType = 0; else if (currentStage === 4) questionType = 3; else if (currentStage === 5) questionType = Math.floor(Math.random() * 4);

    let questionText, questionPinyin, answerKeywords, altAnswerKeywords, questionSubType;
    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
    missionHintEl.classList.add('hidden');

    switch (questionType) {
        case 0: 
            questionText = "ç°åœ¨å‡ ç‚¹ï¼Ÿ"; 
            questionPinyin = "xiÃ nzÃ i jÇ diÇn?"; 
            answerKeywords = [timePeriod, (displayHour === 2 ? 'ë‘' : displayHour.toString()), 'ì ']; 
            altAnswerKeywords = [timePeriod, (displayHour === 2 ? 'ë‘' : chineseNumbers[displayHour.toString()]), 'ì ']; 
            if(minute > 0) { 
                answerKeywords.push(minute.toString(), 'ë¶„'); 
                altAnswerKeywords.push(getChineseMinute(minute), 'ë¶„'); 
            } 
            break;
        case 1: { 
            const subTypes = ['today', 'tomorrow', 'yesterday', 'birthday']; 
            questionSubType = subTypes[Math.floor(Math.random() * subTypes.length)];
            if (questionSubType === 'today') { 
                questionText = "ä»Šå¤©å‡ æœˆå‡ å·ï¼Ÿ"; 
                questionPinyin = "jÄ«ntiÄn jÇ yuÃ¨ jÇ hÃ o?"; 
                answerKeywords = [month.toString(), 'ì›”', day.toString(), 'í˜¸']; 
                altAnswerKeywords = [chineseNumbers[month.toString()], 'ì›”', chineseNumbers[day.toString()], 'í˜¸']; 
            } else if (questionSubType === 'tomorrow') { 
                const tomorrow = getDateInfo({month, day}, 1); 
                questionText = "æ˜å¤©å‡ æœˆå‡ å·ï¼Ÿ"; 
                questionPinyin = "mÃ­ngtiÄn jÇ yuÃ¨ jÇ hÃ o?"; 
                answerKeywords = [tomorrow.month.toString(), 'ì›”', tomorrow.day.toString(), 'í˜¸']; 
                altAnswerKeywords = [chineseNumbers[tomorrow.month.toString()], 'ì›”', chineseNumbers[tomorrow.day.toString()], 'í˜¸']; 
            } else if (questionSubType === 'yesterday') { 
                const yesterday = getDateInfo({month, day}, -1); 
                questionText = "æ˜¨å¤©å‡ æœˆå‡ å·ï¼Ÿ"; 
                questionPinyin = "zuÃ³tiÄn jÇ yuÃ¨ jÇ hÃ o?"; 
                answerKeywords = [yesterday.month.toString(), 'ì›”', yesterday.day.toString(), 'í˜¸']; 
                altAnswerKeywords = [chineseNumbers[yesterday.month.toString()], 'ì›”', chineseNumbers[yesterday.day.toString()], 'í˜¸']; 
            } else { 
                questionText = "ä»–çš„ç”Ÿæ—¥å‡ æœˆå‡ å·ï¼Ÿ"; 
                questionPinyin = "tÄ de shÄ“ngrÃ¬ jÇ yuÃ¨ jÇ hÃ o?"; 
                answerKeywords = [hisBirthday.month.toString(), 'ì›”', hisBirthday.day.toString(), 'í˜¸']; 
                altAnswerKeywords = [chineseNumbers[hisBirthday.month.toString()], 'ì›”', chineseNumbers[hisBirthday.day.toString()], 'í˜¸']; 
            }
            break; 
        }
        case 2: { 
            const subTypes = ['today', 'tomorrow', 'yesterday']; 
            questionSubType = subTypes[Math.floor(Math.random() * subTypes.length)];
            const today = { month, day, dayOfWeek };
            if (questionSubType === 'today') { 
                questionText = "ä»Šå¤©æ˜ŸæœŸå‡ ï¼Ÿ"; 
                questionPinyin = "jÄ«ntiÄn xÄ«ngqÄ« jÇ?"; 
                answerKeywords = [weekdays[today.dayOfWeek]]; 
            } else if (questionSubType === 'tomorrow') { 
                const tomorrow = getDateInfo(today, 1); 
                questionText = "æ˜å¤©æ˜ŸæœŸå‡ ï¼Ÿ"; 
                questionPinyin = "mÃ­ngtiÄn xÄ«ngqÄ« jÇ?"; 
                answerKeywords = [weekdays[tomorrow.dayOfWeek]]; 
            } else { 
                const yesterday = getDateInfo(today, -1); 
                questionText = "æ˜¨å¤©æ˜ŸæœŸå‡ ï¼Ÿ"; 
                questionPinyin = "zuÃ³tiÄn xÄ«ngqÄ« jÇ?"; 
                answerKeywords = [weekdays[yesterday.dayOfWeek]]; 
            }
            break; 
        }
        case 3: 
            questionText = `ä»–å‡ ç‚¹${activity}ï¼Ÿ`; 
            questionPinyin = `tÄ jÇ diÇn ${pinyinMap[activity]}?`; 
            answerKeywords = ['ê·¸', timePeriod, (displayHour === 2 ? 'ë‘' : displayHour.toString()), 'ì ']; 
            altAnswerKeywords = ['ê·¸', timePeriod, (displayHour === 2 ? 'ë‘' : chineseNumbers[displayHour.toString()]), 'ì ']; 
            if (minute > 0) { 
                answerKeywords.push(minute.toString(), 'ë¶„'); 
                altAnswerKeywords.push(getChineseMinute(minute), 'ë¶„'); 
            } 
            answerKeywords.push(activity); 
            altAnswerKeywords.push(activity); 
            missionHintEl.textContent = "(ì‹œê³„ì— í‘œì‹œëœ ì‹œê°„ì„ ë³´ê³  ëŒ€ë‹µí•˜ì„¸ìš”)"; 
            missionHintEl.classList.remove('hidden'); 
            break;
    }

    currentQuestion = { month, day, dayOfWeek, hour, minute, timePeriod, activity, questionText, questionPinyin, answerKeywords, altAnswerKeywords, questionType, questionSubType, displayHour, stage: currentStage };
    updateCalendar(month, day, dayOfWeek);
    updateDigitalClock(hour, minute, timePeriod);
    missionTextHanziEl.textContent = questionText;
    missionTextPinyinEl.textContent = questionPinyin;
    userInputEl.value = "";
    feedbackEl.className = 'mt-4 text-xl font-semibold h-8 text-center';
    feedbackEl.textContent = "";
    recordBtn.disabled = true; // Disable button before audio plays
    nextBtn.classList.add('hidden');
    updateProgressTracker();

    // Automatically speak the new question and re-enable the button on completion
    speak(questionText, 'zh-CN', () => {
        recordBtn.disabled = false;
    });
}

function validateAnswer(transcript) {
    transcript = transcript.replace(/[ì˜å•Šã€‚ï¼Œ]/g, '').trim();
    // For 2 o'clock, consistently use 'ë‘ì ' for checking, as 'ì´ì ' is less common for time.
    if (currentQuestion.displayHour === 2) { 
        transcript = transcript.replace(/ì´ì /g, 'ë‘ì '); 
    }

    const q = currentQuestion;

    // --- Time Questions (Type 0 and 3) ---
    if (q.questionType === 0 || q.questionType === 3) {
        // 1. Check for required non-time keywords
        if (!transcript.includes(q.timePeriod)) return false;
        if (q.questionType === 3) {
            if (!transcript.includes('ê·¸') || !transcript.includes(q.activity)) return false;
        }
        
        // 2. Check for the hour part
        const hourNumStr = q.displayHour.toString();
        const hourHanziStr = (q.displayHour === 2 ? 'ë‘' : chineseNumbers[hourNumStr]);
        
        // Must contain "3ì " OR "ì‚¼ì ".
        const hasHour = transcript.includes(hourNumStr + 'ì ') || transcript.includes(hourHanziStr + 'ì ');
        
        if (!hasHour) return false;

        // 3. Check for the minute part
        if (q.minute === 0) {
            // For o'clock sharp, shouldn't have minute-related words
            return !transcript.includes('ë¶„') && !transcript.includes('ê°') && !transcript.includes('ë°˜');
        }
        if (q.minute === 15) {
            return transcript.includes('ì‹­ì˜¤ë¶„') || transcript.includes('ì¼ê°');
        }
        if (q.minute === 30) {
            // "ë°˜" is used without "ë¶„"
            return transcript.includes('ì‚¼ì‹­ë¶„') || (transcript.includes('ë°˜') && !transcript.includes('ë¶„'));
        }
        if (q.minute === 45) {
            return transcript.includes('ì‚¬ì‹­ì˜¤ë¶„') || transcript.includes('ì‚¼ê°');
        }
        
        // For all other minutes, check for numeric or Hanzi version
        const minuteNumStr = q.minute.toString();
        const minuteHanziStr = getChineseMinute(q.minute);

        const hasMinute = transcript.includes(minuteNumStr + 'ë¶„') || transcript.includes(minuteHanziStr + 'ë¶„');
        return hasMinute;
    }

    // --- Date/Day Questions (Types 1 and 2) ---
    let isCorrect = q.answerKeywords.every(keyword => transcript.includes(keyword));
    if (q.altAnswerKeywords && !isCorrect) {
        isCorrect = q.altAnswerKeywords.every(keyword => transcript.includes(keyword));
    }
    
    // Add 'ì¼' as an alternative to 'í˜¸' for dates
    if (q.questionType === 1 && !isCorrect) { 
        const altKeywordsWithRi = q.answerKeywords.map(k => k === 'í˜¸' ? 'ì¼' : k); 
        isCorrect = altKeywordsWithRi.every(keyword => transcript.includes(keyword)); 
        if (!isCorrect && q.altAnswerKeywords) { 
            const altKeywordsWithRiHanzi = q.altAnswerKeywords.map(k => k === 'í˜¸' ? 'ì¼' : k); 
            isCorrect = altKeywordsWithRiHanzi.every(keyword => transcript.includes(keyword)); 
        } 
    }
    
    // Add 'ì„±ê¸°ì²œ' as an alternative to 'ì„±ê¸°ì¼' for Sunday
    if (q.questionType === 2 && !isCorrect && (q.answerKeywords[0] === "æ˜ŸæœŸæ—¥" || q.answerKeywords[0] === "æ˜ŸæœŸå¤©")) {
        if (transcript.includes("æ˜ŸæœŸæ—¥") || transcript.includes("æ˜ŸæœŸå¤©")) {
            isCorrect = true;
        }
    }

    return isCorrect;
}


function startNewRound() {
    practiceLog = [];
    currentStage = 1;
    questionNumberInStage = 1;
    hisBirthday.month = Math.floor(Math.random() * 12) + 1;
    hisBirthday.day = Math.floor(Math.random() * 28) + 1;
    birthdayInfoEl.textContent = `${hisBirthday.month}ì›” ${hisBirthday.day}ì¼`;
    profileInfoEl.classList.remove('hidden');
    quizSectionEl.classList.remove('hidden');
    startScreenEl.classList.add('hidden');
    generateNewQuestion();
}

function renderResultLog(logContainer, logs) {
    logContainer.innerHTML = '';
    logs.forEach(log => {
        const logWrapper = document.createElement('div');
        const icon = log.isCorrect ? 'âœ…' : 'âŒ';
        const colorClass = log.isCorrect ? 'bg-green-100' : 'bg-red-100';
        let modelAnswer = '';
        const q = log.question;
        let timePart = `${q.timePeriod}${q.displayHour === 2 ? 'ë‘' : chineseNumbers[q.displayHour.toString()]}ì `;
        if (q.minute > 0) { if (q.minute === 15) timePart += 'ì¼ê°'; else if (q.minute === 30) timePart += 'ë°˜'; else if (q.minute === 45) timePart += 'ì‚¼ê°'; else timePart += getChineseMinute(q.minute) + 'ë¶„'; }
        switch(q.questionType) {
            case 0: modelAnswer = timePart; break;
            case 1: {
                if (q.questionSubType === 'today') { modelAnswer = `${chineseNumbers[q.month.toString()]}ì›”${chineseNumbers[q.day.toString()]}í˜¸`; }
                else if (q.questionSubType === 'tomorrow') { const tomorrow = getDateInfo({month: q.month, day: q.day}, 1); modelAnswer = `${chineseNumbers[tomorrow.month.toString()]}ì›”${chineseNumbers[tomorrow.day.toString()]}í˜¸`; }
                else if (q.questionSubType === 'yesterday') { const yesterday = getDateInfo({month: q.month, day: q.day}, -1); modelAnswer = `${chineseNumbers[yesterday.month.toString()]}ì›”${chineseNumbers[yesterday.day.toString()]}í˜¸`; }
                else { modelAnswer = `ê·¸ì˜ ìƒì¼${chineseNumbers[hisBirthday.month.toString()]}ì›”${chineseNumbers[hisBirthday.day.toString()]}í˜¸`; }
                break;
            }
            case 2: {
                 if (q.questionSubType === 'today') { modelAnswer = `${weekdays[q.dayOfWeek]}`; }
                 else if (q.questionSubType === 'tomorrow') { const tomorrow = getDateInfo({month: q.month, day: q.day, dayOfWeek: q.dayOfWeek}, 1); modelAnswer = `${weekdays[tomorrow.dayOfWeek]}`; }
                 else { const yesterday = getDateInfo({month: q.month, day: q.day, dayOfWeek: q.dayOfWeek}, -1); modelAnswer = `${weekdays[yesterday.dayOfWeek]}`; }
                 if (modelAnswer === "æ˜ŸæœŸæ—¥") modelAnswer = "æ˜ŸæœŸæ—¥ / æ˜ŸæœŸå¤©";
                 break;
            }
            case 3: modelAnswer = `ê·¸${timePart}${q.activity}`; break;
        }
        logWrapper.innerHTML = `
        <div class="p-3 rounded-lg text-sm bg-sky-100 text-sky-800 mb-2">
            <div class="flex justify-between items-center">
                <div>
                    <p class="font-bold">â­ ì§ˆë¬¸: ${q.questionText}</p>
                    <p class="text-xs text-gray-600">${q.questionPinyin}</p>
                </div>
                <button data-tts-text="${q.questionText}" class="play-tts-audio-btn audio-btn p-2 rounded-full bg-sky-500 hover:bg-sky-600" title="ì§ˆë¬¸ ë‹¤ì‹œ ë“£ê¸°">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>
        <div class="p-3 rounded-lg text-sm ${colorClass}">
            <div>
                <p class="font-bold">ğŸ˜„ ê·¸ ${icon}</p>
                <p class="text-base my-1">${log.transcript || '(ìŒì„± ì¸ì‹ ì‹¤íŒ¨)'}</p>
                <p class="text-blue-600">${convertFullPhraseToPinyin(log.transcript)}</p>
                ${!log.isCorrect ? `<p class="text-gray-600 mt-1">ëª¨ë²” ë‹µì•ˆ: ${modelAnswer} (${convertFullPhraseToPinyin(modelAnswer)})</p>` : ''}
            </div>
            <div class="flex space-x-2 mt-2">
                 <button data-tts-text="${modelAnswer}" class="play-tts-audio-btn audio-btn text-sm py-1 px-3 bg-gray-500 hover:bg-gray-600">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"></path></svg>
                    ëª¨ë²” ë‹µì•ˆ ë“£ê¸°
                 </button>
            </div>
        </div>`;
        logContainer.appendChild(logWrapper);
    });
}

function showStageResultPopup() {
    const stageLogs = practiceLog.filter(log => log.question.stage === currentStage);
    const finalAttempts = {};
    stageLogs.forEach(log => { finalAttempts[log.question.questionText + JSON.stringify(log.question.answerKeywords)] = log; });
    stageResultTitleEl.textContent = `ğŸ‰ ${currentStage}ë‹¨ê³„ ê²°ê³¼ ğŸ‰`;
    renderResultLog(stageResultLogEl, Object.values(finalAttempts));
    stageResultPopupEl.classList.remove('hidden');
    stageResultPopupEl.classList.add('flex');
}

function showFinalResultPopup() {
    const finalAttempts = {};
    practiceLog.forEach(log => { finalAttempts[log.question.questionText + JSON.stringify(log.question.answerKeywords)] = log; });
    renderResultLog(finalResultLogEl, Object.values(finalAttempts).sort((a,b) => a.question.stage - b.question.stage));
    finalResultPopupEl.classList.remove('hidden');
    finalResultPopupEl.classList.add('flex');
}

// --- Event Listeners ---
startBtn.addEventListener('click', () => {
    startNewRound();
});
nextBtn.addEventListener('click', () => { if (questionNumberInStage >= QUESTIONS_PER_STAGE) { showStageResultPopup(); } else { questionNumberInStage++; generateNewQuestion(); } });
nextStageBtn.addEventListener('click', () => { stageResultPopupEl.classList.add('hidden'); stageResultPopupEl.classList.remove('flex'); currentStage++; questionNumberInStage = 1; if (currentStage > MAX_STAGES) { showFinalResultPopup(); } else { generateNewQuestion(); } });

recordBtn.addEventListener('click', () => {
    if (!recognition) {
        feedbackEl.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        feedbackEl.className += ' text-orange-500 feedback-show';
        return;
    }
    if (isRecognizing) { 
        recognition.stop(); 
        return; 
    }
    
    userInputEl.value = '';
    feedbackEl.className = 'mt-4 text-xl font-semibold h-8 text-center';

    try {
        recognition.start();
    } catch (e) {
        console.error('Recognition start failed:', e);
        feedbackEl.textContent = 'ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        feedbackEl.className += ' text-orange-500 feedback-show';
    }
});

restartBtn.addEventListener('click', () => { finalResultPopupEl.classList.add('hidden'); finalResultPopupEl.classList.remove('flex'); startNewRound(); });
closePopupBtn.addEventListener('click', () => { finalResultPopupEl.classList.add('hidden'); finalResultPopupEl.classList.remove('flex'); quizSectionEl.classList.add('hidden'); startScreenEl.classList.remove('hidden'); profileInfoEl.classList.add('hidden'); });

const resultLogEventHandler = (e) => {
    const ttsBtn = e.target.closest('.play-tts-audio-btn');
    if (ttsBtn) {
        speak(ttsBtn.dataset.ttsText);
    }
};

stageResultLogEl.addEventListener('click', resultLogEventHandler);
finalResultLogEl.addEventListener('click', resultLogEventHandler);


saveResultBtn.addEventListener('click', () => {
    const buttonOriginalText = saveResultBtn.textContent;
    saveResultBtn.textContent = 'ì €ì¥ ì¤‘...';
    saveResultBtn.disabled = true;

    html2canvas(finalResultContentEl).then(canvas => {
        const link = document.createElement('a');
        link.download = 'panda-time-quiz-result.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        saveResultBtn.textContent = buttonOriginalText;
        saveResultBtn.disabled = false;
    }).catch(err => {
        console.error("ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:", err);
        saveResultBtn.textContent = 'ì €ì¥ ì‹¤íŒ¨';
        setTimeout(() => {
            saveResultBtn.textContent = buttonOriginalText;
            saveResultBtn.disabled = false;
        }, 2000);
    });
});

// --- Speech Recognition Handlers ---
if (recognition) {
    recognition.onstart = () => {
        isRecognizing = true;
        recordBtn.classList.add('recording');
    };
    recognition.onend = () => {
        isRecognizing = false;
        recordBtn.classList.remove('recording');
    };
    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        userInputEl.value = transcript;

        const isCorrect = validateAnswer(transcript);
        practiceLog.push({ question: { ...currentQuestion }, transcript, isCorrect });

        if (isCorrect) {
            feedbackEl.textContent = 'ì •í™•í•´ìš”! ğŸ‘';
            feedbackEl.className += ' text-green-600 feedback-show';
            recordBtn.disabled = true;
            nextBtn.classList.remove('hidden');
        } else {
            feedbackEl.textContent = 'ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”. ğŸ¤”';
            feedbackEl.className += ' text-red-500 feedback-show';
            recordBtn.disabled = false;
        }
    };
    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error, event.message);
        isRecognizing = false;
        recordBtn.classList.remove('recording');
        let errorMessage = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. (${event.error})`;
        if (event.error === 'no-speech') errorMessage = 'ìŒì„±ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆì–´ìš”.';
        else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') errorMessage = 'ë§ˆì´í¬ ì‚¬ìš©ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. (ê¸°ê¸°/ë¸Œë¼ìš°ì € ì„¤ì • í™•ì¸)';
        else if (event.error === 'network') errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        else if (event.error === 'audio-capture') errorMessage = 'ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë‹¤ë¥¸ ì•± ì‚¬ìš© í™•ì¸/ì¬ë¶€íŒ… í•„ìš”)';
        feedbackEl.textContent = errorMessage;
        feedbackEl.className += ' text-orange-500 feedback-show';
    };
}
</script>
</body>
</html>