<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒì¼ ë¬»ê³  ë‹µí•˜ê¸° ì—°ìŠµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Jua', sans-serif; touch-action: manipulation; }
        .game-container { background: linear-gradient(135deg, #fce4ec, #e3f2fd); border: 4px solid #ffc107; }
        .calendar { background-color: #fffde7; border: 3px solid #ffca28; border-radius: 1rem; padding: 1rem; text-align: center; box-shadow: 0 6px 12px rgba(0,0,0,0.1); min-width: 220px; position: relative; }
        #month-display { font-size: 1.5rem; font-weight: bold; color: #c53030; background-color: #fed7d7; padding: 0.25rem 0; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
        #day-display { font-size: 5rem; font-weight: bold; color: #1e3a8a; line-height: 1.1; padding: 0.5rem 0; }
        #birthday-icon { font-size: 1.75rem; background-color: #f6ad55; color: white; border-radius: 9999px; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; margin: 0.5rem auto; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #record-btn.recording { animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0.7); }
            70% { box-shadow: 0 0 0 12px rgba(251, 146, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(251, 146, 60, 0); }
        }
        @keyframes pop-in {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .feedback-show { animation: pop-in 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        .audio-btn { border-radius: 9999px; color: white; cursor: pointer; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-blue-50 flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto max-w-md">
        <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-6 game-container">
            <header class="text-center mb-4">
                <h1 class="text-2xl sm:text-3xl font-bold text-blue-600">ğŸ¼ íŒë‹¤ì˜ ìƒì¼ ë§íˆê¸° ğŸ‚</h1>
                <p class="text-gray-500 mt-1 text-base">ë‹¬ë ¥ì„ ë³´ê³  ì§ˆë¬¸ì— ë‹µí•´ë´ìš”!</p>
            </header>
            
            <section class="flex flex-row flex-wrap items-center justify-center gap-4 mb-4">
                <div id="calendar-container" class="calendar flex-1 hidden">
                    <div id="month-display">1ì›”</div>
                    <div id="birthday-icon">ğŸ‚</div>
                    <div id="day-display">1</div>
                </div>
            </section>
            
            <section id="start-screen" class="text-center py-4">
                <p class="text-lg mb-4 text-gray-700">ì´ 6ê°œì˜ ìƒì¼ í€´ì¦ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤!</p>
                <button id="start-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105 shadow-lg">ì‹œì‘!</button>
                <p id="start-error" class="text-sm text-red-500 mt-2 h-5"></p>
            </section>

            <section id="quiz-section" class="hidden">
                <div id="progress-tracker" class="text-center mb-2 bg-white/50 rounded-lg p-2">
                    <span id="stage-info" class="font-bold text-blue-700"></span> | <span id="question-progress" class="text-gray-600"></span>
                </div>
                <div id="mission-card" class="bg-sky-100 border-2 border-sky-300 text-sky-800 p-3 rounded-lg mb-4 text-center shadow-md">
                    <p class="font-bold text-lg">â­ ì§ˆë¬¸! â­</p>
                    <div class="mt-2">
                        <p id="mission-text-hanzi" class="text-xl text-sky-900 font-bold">...</p>
                        <p id="mission-text-pinyin" class="text-md text-sky-700 mt-1">...</p>
                    </div>
                </div>

                <div class="user-response-area mt-2 bg-white p-2 rounded-lg shadow-inner">
                    <p class="font-bold text-left text-gray-600 text-sm">ğŸ˜„ ê·¸/ê·¸ë…€ (tÄ):</p>
                    <input type="text" id="user-input" class="bg-transparent text-gray-800 text-base placeholder-gray-500 w-full text-center outline-none py-1" placeholder="ìŒì„±ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”" readonly>
                    <p id="user-pinyin" class="text-center text-blue-600 text-base h-6 mt-1"></p>
                </div>

                <div id="controls" class="text-center mt-4">
                    <button id="record-btn" class="bg-orange-400 hover:bg-orange-500 text-white font-bold p-3 rounded-full transition-transform transform hover:scale-110 shadow-lg inline-flex items-center justify-center" title="ìŒì„±ìœ¼ë¡œ ë‹µë³€í•˜ê¸°">
                        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-12 0H3a7.001 7.001 0 006 6.93V17H7v1h6v-1h-2v-2.07z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>

                <p id="feedback" class="mt-2 text-lg font-semibold h-7 text-center"></p>

                <div class="text-center mt-2">
                    <button id="next-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-5 rounded-full text-base hidden">ë‹¤ìŒ ë¬¸ì œ</button>
                </div>
            </section>
        </div>
    </div>
    
    <!-- ìµœì¢… ê²°ê³¼ íŒì—… -->
    <div id="final-result-popup" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div id="final-result-content">
                <header class="text-center mb-4 flex-shrink-0">
                    <h2 class="text-3xl font-bold text-blue-600">ğŸ‰ ìµœì¢… ì—°ìŠµ ê²°ê³¼ ğŸ‰</h2>
                </header>
                <div id="final-result-log" class="flex-grow overflow-y-auto space-y-4 pr-2 border-t pt-4 max-h-[50vh]"></div>
            </div>
            <footer class="mt-6 text-center flex-shrink-0 space-y-2 sm:space-x-4">
                <button id="restart-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full text-xl mt-2 sm:mt-0">ë‹¤ì‹œí•˜ê¸°</button>
                <button id="close-popup-btn" class="text-gray-500 hover:text-gray-700 text-sm mt-2 sm:mt-0">ë‹«ê¸°</button>
            </footer>
        </div>
    </div>

<script>
// DOM Elements
const calendarContainerEl = document.getElementById('calendar-container');
const monthDisplayEl = document.getElementById('month-display');
const dayDisplayEl = document.getElementById('day-display');
const startScreenEl = document.getElementById('start-screen');
const startBtn = document.getElementById('start-btn');
const startErrorEl = document.getElementById('start-error');
const quizSectionEl = document.getElementById('quiz-section');
const stageInfoEl = document.getElementById('stage-info');
const questionProgressEl = document.getElementById('question-progress');
const missionTextHanziEl = document.getElementById('mission-text-hanzi');
const missionTextPinyinEl = document.getElementById('mission-text-pinyin');
const userInputEl = document.getElementById('user-input');
const userPinyinEl = document.getElementById('user-pinyin');
const recordBtn = document.getElementById('record-btn');
const feedbackEl = document.getElementById('feedback');
const nextBtn = document.getElementById('next-btn');
const finalResultPopupEl = document.getElementById('final-result-popup');
const finalResultLogEl = document.getElementById('final-result-log');
const restartBtn = document.getElementById('restart-btn');
const closePopupBtn = document.getElementById('close-popup-btn');
const finalResultContentEl = document.getElementById('final-result-content');


// --- Speech API Setup ---
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;
let isRecognizing = false;
let userInteracted = false;

if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.lang = 'zh-CN';
  recognition.interimResults = false;
  recognition.continuous = false;
  recognition.maxAlternatives = 1;
} else {
  startErrorEl.textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
  recordBtn.disabled = true;
  recordBtn.style.display = 'none';
}

// --- Game Data ---
const birthdays = [
    { month: 1, day: 8 }, { month: 2, day: 5 }, { month: 3, day: 4 },
    { month: 4, day: 15 }, { month: 5, day: 9 }, { month: 12, day: 3 }
];
const chineseNumbers = { '1': 'ä¸€', '2': 'äºŒ', '3': 'ä¸‰', '4': 'å››', '5': 'äº”', '6': 'å…­', '7': 'ä¸ƒ', '8': 'å…«', '9': 'ä¹', '10': 'å', '11': 'åä¸€', '12': 'åäºŒ', '13': 'åä¸‰', '14': 'åå››', '15': 'åäº”', '16': 'åå…­', '17': 'åä¸ƒ', '18': 'åå…«', '19': 'åä¹', '20': 'äºŒå', '21': 'äºŒåä¸€', '22': 'äºŒåäºŒ', '23': 'äºŒåä¸‰', '24': 'äºŒåå››', '25': 'äºŒåäº”', '26': 'äºŒåå…­', '27': 'äºŒåä¸ƒ', '28': 'äºŒåå…«', '29': 'äºŒåä¹', '30': 'ä¸‰å', '31': 'ä¸‰åä¸€' };
const pinyinMap = {
    'ä»–': 'tÄ', 'å¥¹': 'tÄ', 'çš„': 'de', 'ç”Ÿæ—¥': 'shÄ“ngrÃ¬', 'æ˜¯': 'shÃ¬', 'æœˆ': 'yuÃ¨', 'å·': 'hÃ o', 'æ—¥': 'rÃ¬', 'å‡ ': 'jÇ',
    'ä¸€': 'yÄ«', 'äºŒ': 'Ã¨r', 'ä¸‰': 'sÄn', 'å››': 'sÃ¬', 'äº”': 'wÇ”', 'å…­': 'liÃ¹', 'ä¸ƒ': 'qÄ«', 'å…«': 'bÄ', 'ä¹': 'jiÇ”', 'å': 'shÃ­',
    'åä¸€': 'shÃ­yÄ«', 'åäºŒ': 'shÃ­Ã¨r', 'åä¸‰': 'shÃ­sÄn', 'åå››': 'shÃ­sÃ¬', 'åäº”': 'shÃ­wÇ”', 'åå…­': 'shÃ­liÃ¹', 'åä¸ƒ': 'shÃ­qÄ«', 'åå…«': 'shÃ­bÄ', 'åä¹': 'shÃ­jiÇ”',
    'äºŒå': 'Ã¨rshÃ­', 'äºŒåä¸€': 'Ã¨rshÃ­yÄ«', 'äºŒåäºŒ': 'Ã¨rshÃ­Ã¨r', 'äºŒåä¸‰': 'Ã¨rshÃ­sÄn', 'äºŒåå››': 'Ã¨rshÃ­sÃ¬', 'äºŒåäº”': 'Ã¨rshÃ­wÇ”', 'äºŒåå…­': 'Ã¨rshÃ­liÃ¹',
    'äºŒåä¸ƒ': 'Ã¨rshÃ­qÄ«', 'äºŒåå…«': 'Ã¨rshÃ­bÄ', 'äºŒåä¹': 'Ã¨rshÃ­jiÇ”', 'ä¸‰å': 'sÄnshÃ­', 'ä¸‰åä¸€': 'sÄnshÃ­yÄ«'
};

// --- Game State ---
let currentQuestion = {};
let practiceLog = [];
let questionNumber = 1;
const TOTAL_QUESTIONS = birthdays.length;
let shuffledBirthdayIndices = [];

// --- Helper Functions ---
window.addEventListener('pointerdown', () => { userInteracted = true; }, { once: true });

function speak(text, lang = 'zh-CN', callback) {
    if (!text || !userInteracted || !window.speechSynthesis) { if (callback) callback(); return; }
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = lang;
    utterance.onend = () => { if (callback) callback(); };
    utterance.onerror = (event) => { console.error('SpeechSynthesis Error:', event.error); if (callback) callback(); };
    window.speechSynthesis.speak(utterance);
}

function convertToPinyin(text) {
    if (!text) return '';
    const words = Object.keys(pinyinMap).sort((a, b) => b.length - a.length);
    let remainingText = text.replace(/[.,ã€‚/()]/g, '');
    let pinyinText = '';
    while (remainingText.length > 0) {
        let found = false;
        for (const word of words) {
            if (remainingText.startsWith(word)) {
                pinyinText += pinyinMap[word] + ' ';
                remainingText = remainingText.substring(word.length);
                found = true;
                break;
            }
        }
        if (!found) { pinyinText += remainingText[0]; remainingText = remainingText.substring(1); }
    }
    pinyinText = pinyinText.trim();
    if (pinyinText.length > 0) { pinyinText = pinyinText.charAt(0).toUpperCase() + pinyinText.slice(1); }
    return pinyinText;
}

function updateCalendar(month, day) {
    monthDisplayEl.textContent = `${month}ì›”`;
    dayDisplayEl.textContent = day;
}

function updateProgressTracker() {
    stageInfoEl.textContent = `ìƒì¼ ë§íˆê¸°`;
    questionProgressEl.textContent = `ë¬¸ì œ ${questionNumber}/${TOTAL_QUESTIONS}`;
}

// --- Core Game Logic ---
function generateNewQuestion() {
    const birthdayIndex = shuffledBirthdayIndices[questionNumber - 1];
    const currentBirthday = birthdays[birthdayIndex];
    
    calendarContainerEl.classList.remove('hidden');
    updateCalendar(currentBirthday.month, currentBirthday.day);
    
    const questionText = "ä»–(/å¥¹)çš„ç”Ÿæ—¥å‡ æœˆå‡ å·ï¼Ÿ";
    const questionPinyin = "TÄ de shÄ“ngrÃ¬ jÇ yuÃ¨ jÇ hÃ o?";
    
    currentQuestion = {
        questionText,
        questionPinyin,
        month: currentBirthday.month,
        day: currentBirthday.day
    };

    missionTextHanziEl.textContent = questionText;
    missionTextPinyinEl.textContent = questionPinyin;
    userInputEl.value = "";
    userPinyinEl.textContent = "";
    feedbackEl.className = 'mt-2 text-lg font-semibold h-7 text-center';
    feedbackEl.textContent = "";
    recordBtn.disabled = true;
    nextBtn.classList.add('hidden');
    updateProgressTracker();

    speak(questionText, 'zh-CN', () => { recordBtn.disabled = false; });
}

function validateAnswer(transcript) {
    transcript = transcript.replace(/[.,ã€‚çš„ç”Ÿæ—¥æ˜¯]/g, '').trim();
    const { month, day } = currentQuestion;
    
    const answerFormats = [
        `${month}æœˆ${day}å·`,
        `${month}æœˆ${day}æ—¥`,
        `${chineseNumbers[month]}æœˆ${chineseNumbers[day]}å·`,
        `${chineseNumbers[month]}æœˆ${chineseNumbers[day]}æ—¥`
    ];
    
    return answerFormats.some(format => transcript.includes(format));
}

function startNewRound() {
    practiceLog = [];
    questionNumber = 1;
    
    shuffledBirthdayIndices = Array.from(Array(birthdays.length).keys());
    for (let i = shuffledBirthdayIndices.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffledBirthdayIndices[i], shuffledBirthdayIndices[j]] = [shuffledBirthdayIndices[j], shuffledBirthdayIndices[i]];
    }
    
    quizSectionEl.classList.remove('hidden');
    startScreenEl.classList.add('hidden');
    generateNewQuestion();
}

function renderResultLog(logContainer, logs) {
    logContainer.innerHTML = '';
    logs.forEach(log => {
        const logWrapper = document.createElement('div');
        const icon = log.isCorrect ? 'âœ…' : 'âŒ';
        const colorClass = log.isCorrect ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300';
        const modelAnswer = `${chineseNumbers[log.question.month]}æœˆ${chineseNumbers[log.question.day]}å·`;
        const speakerSVG = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"></path></svg>`;

        logWrapper.innerHTML = `
        <div class="p-3 rounded-lg border-2 ${colorClass} space-y-2">
            <p class="font-bold text-gray-700">[${log.question.month}ì›” ${log.question.day}ì¼]</p>
            <div class="bg-white/50 p-2 rounded-md flex justify-between items-center">
                <div><p class="font-bold text-sky-800">â­ ì§ˆë¬¸</p><p>${log.question.questionText}</p></div>
                <button data-tts-text="${log.question.questionText}" class="play-tts-audio-btn audio-btn p-2 bg-sky-500 hover:bg-sky-600">${speakerSVG}</button>
            </div>
            <div class="bg-white/50 p-2 rounded-md">
                <p class="font-bold text-gray-800">ğŸ˜„ ë‹µë³€ ${icon}</p>
                <p class="my-1">${log.transcript || '(ìŒì„± ì¸ì‹ ì‹¤íŒ¨)'}</p>
                <div class="flex justify-between items-center mt-2">
                    <div><p class="font-bold text-emerald-800">ğŸ’¡ ëª¨ë²” ë‹µì•ˆ</p><p>${modelAnswer}</p></div>
                    <button data-tts-text="${modelAnswer}" class="play-tts-audio-btn audio-btn p-2 bg-emerald-500 hover:bg-emerald-600">${speakerSVG}</button>
                </div>
            </div>
        </div>`;
        logContainer.appendChild(logWrapper);
    });
}

function showFinalResultPopup() {
    practiceLog.sort((a, b) => (a.question.month * 100 + a.question.day) - (b.question.month * 100 + b.question.day));
    renderResultLog(finalResultLogEl, practiceLog);
    finalResultPopupEl.classList.remove('hidden');
    finalResultPopupEl.classList.add('flex');
}

// --- Event Listeners ---
startBtn.addEventListener('click', startNewRound);
nextBtn.addEventListener('click', () => {
    questionNumber++;
    if (questionNumber > TOTAL_QUESTIONS) {
        showFinalResultPopup();
    } else {
        generateNewQuestion();
    }
});
recordBtn.addEventListener('click', () => {
    if (!recognition) return;
    if (isRecognizing) { recognition.stop(); return; }
    userInputEl.value = '';
    userPinyinEl.textContent = '';
    feedbackEl.className = 'mt-2 text-lg font-semibold h-7 text-center';
    try { recognition.start(); } catch (e) {
        feedbackEl.textContent = 'ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
        feedbackEl.className += ' text-orange-500 feedback-show';
    }
});
restartBtn.addEventListener('click', () => {
    finalResultPopupEl.classList.add('hidden');
    finalResultPopupEl.classList.remove('flex');
    startNewRound();
});
closePopupBtn.addEventListener('click', () => {
    finalResultPopupEl.classList.add('hidden');
    finalResultPopupEl.classList.remove('flex');
    quizSectionEl.classList.add('hidden');
    startScreenEl.classList.remove('hidden');
    calendarContainerEl.classList.add('hidden');
});
finalResultLogEl.addEventListener('click', (event) => {
    const ttsBtn = event.target.closest('.play-tts-audio-btn');
    if (ttsBtn) { speak(ttsBtn.dataset.ttsText); }
});

// --- Speech Recognition Handlers ---
if (recognition) {
    recognition.onstart = () => { isRecognizing = true; recordBtn.classList.add('recording'); };
    recognition.onend = () => { isRecognizing = false; recordBtn.classList.remove('recording'); };
    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        userInputEl.value = transcript;
        userPinyinEl.textContent = convertToPinyin(transcript);
        const isCorrect = validateAnswer(transcript);
        const logEntry = { question: { ...currentQuestion }, transcript, isCorrect };
        
        const existingLogIndex = practiceLog.findIndex(log => log.question.month === currentQuestion.month && log.question.day === currentQuestion.day);
        if (existingLogIndex > -1) { practiceLog[existingLogIndex] = logEntry; } 
        else { practiceLog.push(logEntry); }

        if (isCorrect) {
            feedbackEl.textContent = 'ä½ çœŸæ£’ï¼';
            feedbackEl.className += ' text-green-600 feedback-show';
            speak('ä½ çœŸæ£’ï¼');
            recordBtn.disabled = true;
            nextBtn.classList.remove('hidden');
        } else {
            feedbackEl.textContent = 'å†æƒ³æƒ³ã€‚';
            feedbackEl.className += ' text-red-500 feedback-show';
            speak('å†æƒ³æƒ³ã€‚');
            recordBtn.disabled = false;
        }
    };
    recognition.onerror = (event) => {
        isRecognizing = false;
        recordBtn.classList.remove('recording');
        let errorMessage = `ì˜¤ë¥˜: ${event.error}`;
        if (event.error === 'no-speech') errorMessage = 'ìŒì„±ì„ ì¸ì‹í•˜ì§€ ëª»í–ˆì–´ìš”.';
        if (event.error === 'not-allowed') errorMessage = 'ë§ˆì´í¬ ì‚¬ìš©ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.';
        feedbackEl.textContent = errorMessage;
        feedbackEl.className += ' text-orange-500 feedback-show';
    };
}
</script>
</body>
</html>